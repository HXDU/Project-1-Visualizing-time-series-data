<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */
path{
  stroke-width: 1;
}
.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

.line--fade {
  opacity: 0.5;
}

.line--hover {
  stroke-width: 3px;
  opacity: 1.0;
}

.axisSteelBlue text{
  fill: #4B999F;
  opacity: 1.5;
  font-size: 12px;
}
.axisOrange text{
  fill: #D2691E;
  opacity: 1.5;
  font-size: 12px;
}

.axisRegular text{
  opacity: 1.5;
  font-size: 12px;
}

.tooltip{
  position: absolute;
  opacity: 0;

}

</style>

<body id = "total_wildfire">
  <table>
    <!--The first row: only one big graph-->
    <tr>
      <td style = "vertical-align: top;">
        <svg id = "unknown" width = "300" height = "500" position = "absolute"></svg>
        <svg width = "860" height = "500" id = "total_over_time"></svg>
      </td>
    </tr>

    <tr>
      <td style = "vertical-align: top;">
        <div id = "topic_options" width = "150" height = "150" position = "absolute"></div>
        <div id = "theTopicText" position = "absolute"></div>
      </td>

      <td style = "vertical-align: top;">
        <!--button onclick="update(loc)" style = "vertical-align: top;">Locations</button>
        <button onclick="update(cot)" style = "vertical-align: top;">Contents</button-->
        <svg width = "1000" height = "600" id = "graph2"></svg>
        <div id = "tool"></div>
      </td>
    </tr>

  </table>

<!-- load the d3.js library -->
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

//Step 1: draw the topic dropdownButton part
//topic options
var topics = [
    ["air","smoke","area","quality","due"],
    ["wildfire","safe","survivor","stay","hope"],
    ["county","butte","million","san","reveal"],
    ["death","update","acres","contain","paradise"],
    ["wildfire","california","affect","home","lost"],
    ["great","first","blame","time","get"],
    ["new","donate","thank","place","favorite"],
    ["wildfire","california","fire","cause","camp"],
    ["help","victim","please","need","support"],
    ["california","wildfire","trump","via","deadly"]
];

var options = ["Choose","Topic 1", "Topic 2", "Topic 3", "Topic 4", "Topic 5", "Topic 6", "Topic 7", "Topic 8", "Topic 9", "Topic 10"];

var dropdownButton = d3.select("#topic_options")
                        .append('select');

dropdownButton.selectAll('myOptions')
              .data(options)
              .enter()
              .append('option')
              .text(function(d){return d;})
              .attr("value", function(d){return d;});

var show_topic = d3.select("#theTopicText");

function showTopic(index){
   show_topic.append("text")
          .text("Topic "+ (index + 1) + ":" + topics[index]).append("br")
          .style("font-size","13px");
}
//when the button is chosen, it will show the coorespond topics.
//click the choose button, all the output will be cleared
dropdownButton.on("change", function(d){
  var selectedOption = d3.select(this).property("value");
  var temp = selectedOption.split(' ');
  var index = temp[1];
  //If choose was taken
  if(isNaN(index)){
     //js way to clear
     // document.getElementById('theTopicText').innerHTML = "";
     //d3 way to clear
     show_topic.html("");
     console.log("hello");
  }
  else{
    showTopic(index - 1);
  }
})

//Add titles for the button
var title = d3.select("#topic_options");
//An empty line after the button
title.append("text")
     .text("")
     .append("br");

title.append("text")
          .text("*Top 10 Topics Generated by LDA Topic Modeling").style("font-size","15px");

//Step 2: draw the over time graph 1
// set the dimensions and margins of the graph
var margin = {top: 30, right: 50, bottom: 40, left: 100},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// set the ranges
var x = d3.scaleTime().range([0, width]);
var y0 = d3.scaleLinear().range([height, 0]);
var y1 = d3.scaleLinear().range([height, 0]);

// define the 1st line
var valueline = d3.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y0(d.total_valid); });

// define the 2nd line
var valueline2 = d3.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y1(d.CA_wildfire); });

// append the svg obgect to the body of the page
// appends a 'group' element to 'svg'
// moves the 'group' element to the top left margin
//var svg = d3.select("body").append("svg")
var svg = d3.select("#total_over_time")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("position","absolute")
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
//d3.select("tooltip").append("svg")
//build tooltip
var div = d3.select("body")
            .append("div")
            .attr("class","tooltip")
            .attr("opacity", 0);

// Get the data
d3.csv("CAtweets.csv", function(error, data) {
  if (error) throw error;
  // format the data
  data.forEach(function(d) {
      //the format of time
      d.date = d3.timeParse("%d-%b-%y")(d.date);
      d.total_valid = +d.total_valid;
      d.CA_wildfire = +d.CA_wildfire;
      d.rescue = +d.rescue;
      d.CA_based = +d.CA_based;
      d.Other_loc = +d.Other_loc;
  });

  console.log(data);

  // Scale the range of the data
  x.domain(d3.extent(data, function(d) { return d.date; }));
  y0.domain([0, 2000000]);
  y1.domain([0, 5000]);

  //Add the title
  svg.append("text")
     .text("CA Wildfire Tweets: Year 2018")
     .style("font-size","20px")
     .attr("transform", "translate(" + width/3 + ", 0 )");

  // Add the valueline path.
  svg.append("path")
      .data([data])
      .attr("class", "line")
      .style("stroke","#4B999F")
      .attr("d", valueline)
  		.on("mouseover", mouseover)
  		.on("mouseout", mouseout);

  // Add the valueline2 path.
  svg.append("path")
      .data([data])
      .attr("class", "line")
      .style("stroke", "#D2691E")
      .attr("d", valueline2)
      .on("mouseover", mouseover)
  		.on("mouseout", mouseout);

  // Add the X Axis
  svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x)
      .tickFormat(d3.timeFormat('%m-%d')).ticks(data.length))
      .style("opacity","0.8");

  // Add the Y0 Axis
  svg.append("g")
      .attr("class", "axisSteelBlue")
      .call(d3.axisLeft(y0))
      .append("text")
      .text("Total Tweets collected")
      //.attr("transform","rotate(-90)")
      .style("font-size","12px")
      .style("text-anchor","start");

  // Add the Y1 Axis
  svg.append("g")
      .attr("class", "axisOrange")
      .attr("transform", "translate( " + width + ", 0 )")
      .call(d3.axisRight(y1))
      .append("text")
      .text("CA wildfire tweets")
      .style("font-size","12px")
      .style("text-anchor","end");

  function mouseover(d) {
    var x0 = x.invert(d3.mouse(this)[0]);
    var y0 = d3.event.pageY;
    var xP = d3.event.pageX;
    var bisectDate = d3.bisector(function(d) {return d.date;}).left;
    var index = bisectDate(data, x0, 1);

    div.style('left', ((d3.event.pageX + 15) + "px")).style('top', ((d3.event.pageY + 15) + "px"));
    div.transition().duration(10).style("opacity","1.2").style("font-size" ,"12px");
    div.style("stroke","lightgrey").html(function(d){
      if (y0 > 300){
        return data[index-1].CA_wildfire;
      }
      if (y0 < 300){
        return data[index-1].total_valid;
      }
    });
    paused = true;
  }

  function mouseout(d) {
    div.transition().duration(10).style("opacity", 0);
    paused = false;
  }

  var margin2 = {top: 20, right: 30, bottom: 30, left: 50},
    width2 = 900 - margin2.left - margin2.right;
    height2 = 500 - margin2.top - margin2.bottom;
  var legendGap = 25;
 //Step 3: draw a second grph
  var svg2 = d3.select("#graph2")
      .append("svg")
      .attr("width", width2 + margin2.left + margin2.right)
      .attr("height", height2 + margin2.top + margin2.bottom)
      .style("position","absolute")
      .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")")
      .append("g")
      .attr("transform","translate("+ margin2.left + "," + margin2.top + ")");

  // set the ranges
  var x2 = d3.scaleTime().range([0, width2]);
  var y2 = d3.scaleLinear().range([height2, 0]);

  // define the 1st line
  var valueline_graph2_res = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y2(d.rescue); });

  // define the 2nd line
  var valueline_graph2_wildfire = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y2(d.CA_wildfire); });

  //define the 3rd line
  var valueline_graph2_CAbased = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y2(d.CA_based); });

   //define the 4th line
   var valueline_graph2_otherloc = d3.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y2(d.Other_loc); });

   // Scale the range of the data
  x2.domain(d3.extent(data, function(d) { return d.date; }));
  y2.domain([0,2000]);

  // Add the X Axis
  svg2.append("g")
      .attr("transform", "translate(0," + height2 + ")")
      .call(d3.axisBottom(x2).tickFormat(d3.timeFormat('%m-%d')).ticks(data.length))
      .style("opacity","0.8");

  // Add the Y Axis
  svg2.append("g")
      .attr("class", "axisRegular")
      .call(d3.axisLeft(y2));

  //Add legends
  svg2.append("rect")
      .attr("height",5)
      .attr("width", legendGap)
      .attr("fill","green")
      .attr("transform","translate("+ legendGap + ",0)");

  svg2.append("text").text("CA Wildfire Tweets")
      .style("font-size", "13px")
      .style("cursor","pointer")
      .attr("transform", "translate(" + 2*legendGap + ",3)")
      .on("click", function(d){
        currentOpa = d3.select(".wildfire").style("opacity");
        d3.select(".wildfire").transition()
          .style("opacity", currentOpa == 1? 0:1)
      });

  svg2.append("rect")
      .attr("height",5)
      .attr("width", legendGap)
      .attr("fill","red")
      .attr("transform","translate("+ 8*legendGap + ",0)");

  svg2.append("text").text("Those Located in CA")
      .style("font-size", "13px")
      .style("cursor","pointer")
      .attr("transform", "translate(" + 9*legendGap + ",3)")
      .on("click", function(d){
        currentOpa = d3.select(".CAbased").style("opacity");
        d3.select(".CAbased").transition()
            .style("opacity", currentOpa == 1? 0:1)
      });

  svg2.append("rect")
      .attr("height",5)
      .attr("width", legendGap)
      .attr("fill","purple")
      .attr("transform","translate("+ 16*legendGap + ",0)");

  svg2.append("text").text("Other than CA")
      .style("font-size", "13px")
      .style("cursor","pointer")
      .attr("transform", "translate(" + 17*legendGap + ",3)")
      .on("click", function(d){
        currentOpa = d3.select(".otherLoc").style("opacity");
        d3.select(".otherLoc").transition()
          .style("opacity", currentOpa == 1? 0:1)
        });

  svg2.append("rect")
      .attr("height",5)
      .attr("width", legendGap)
      .attr("fill","blue")
      .attr("transform","translate("+ 8*legendGap + ",20)");

  svg2.append("text").text("Those are Rescue-related")
      .style("font-size", "13px")
      .style("cursor","pointer")
      .attr("transform", "translate(" + 9*legendGap + ",23)")
      .on("click", function(d){
          currentOpa = d3.select(".res").style("opacity");
          d3.select(".res").transition()
            .style("opacity", currentOpa == 1? 0:1)
        });

    //Add the valueline_graph2_res path
  svg2.append("path")
        .data([data])
        .attr("class","line res")
        .style("stroke","blue")
        .style("opacity",0)
        .attr("d", valueline_graph2_res)
        .on("mouseover",drawToolTip)
        .on("mouseout",removeToolTip);

  svg2.append("path")
        .data([data])
        .attr("class","line otherLoc")
        .style("stroke","purple")
        .style("opacity",0)
        .attr("d", valueline_graph2_otherloc)
        .on("mouseover",drawToolTip)
        .on("mouseout",removeToolTip);

  svg2.append("path")
        .data([data])
        .attr("class","line CAbased")
        .style("stroke","red")
        .style("opacity",0)
        .attr("d", valueline_graph2_CAbased)
        .on("mouseover",drawToolTip)
        .on("mouseout",removeToolTip);

  svg2.append("path")
        .data([data])
        .attr("class","line wildfire")
        .style("stroke","green")
        .style("opacity",0)
        .attr("d", valueline_graph2_wildfire)
        .on("mouseover",drawToolTip)
        .on("mouseout",removeToolTip);

var tipBox = d3.select("body").append("graph2")
        .attr("class","tooltip")
        .attr("opacity", 1);

//when mouse is on one of the lines, it will show all the coorespond vaues
//of all lines that are shown on the graph
function drawToolTip(d){
  var x20 = x.invert(d3.mouse(this)[0]);
  // var y20 = d3.event.pageY;
  // var x2P = d3.event.pageX;
  var bisectDate = d3.bisector(function(d) {return d.date;}).left;
  var index = bisectDate(data, x20, 1);

  var wd_op = d3.select(".wildfire").style("opacity");
  var res_op = d3.select(".res").style("opacity");
  var ca_op = d3.select(".CAbased").style("opacity");
  var other_op = d3.select(".otherLoc").style("opacity");

  tipBox.style('left', ((d3.event.pageX + 25) + "px"))
         .style('top', ((d3.event.pageY + 15) + "px"));

  tipBox.transition()
        .duration(10)
        .style("opacity","1.0")
        .style("font-size" ,"14px");

  tipBox.style("stroke","black").html(function(d){
      var tool_wildfire = "<br>",
      tool_CA = "",
      tool_other ="",
      tool_res = "<br>";
      //assign the values based on whether the line is drawn
      if (wd_op == 1){
         tool_wildfire = "Total: " + data[index-1].CA_wildfire + "<br>"; }
      if (res_op == 1){
        tool_res = "Rescue: " + data[index-1].rescue + "<br>";}
      if (ca_op == 1){
        tool_CA = "Loc in CA: " + data[index-1].CA_based + "<br>"; }
      if (other_op == 1){
        tool_other = "Other Loc: " + data[index-1].Other_loc + "<br>"; }

      return tool_wildfire + tool_CA + tool_other + tool_res;
  });
  paused = true;
}
//the values disappear when the mouse is out
function removeToolTip(d){
  tipBox.transition().duration(10).style("opacity", 0);
  paused = false;
}

});

</script>
</body>
